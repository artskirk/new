<?php

namespace Datto\Malware\RansomwareRules;

use Datto\Malware\RansomwareConfiguration;
use Datto\Malware\RansomwareRule;
use \PDO;

/**
 * Ransomware rule
 * @author Chuck Roydhouse <cer@datto.com>
 */
class KnownRansomwareExtensions extends RansomwareRule
{
    /** Rule description */
    const DESCRIPTION = 'Detects file entries that contain a known ransomware extension';

    /** Default positive occurrence threshold (threshold = (occurrence / total)) */
    const DEFAULT_OCCURRENCE_THRESHOLD = 0.005;

    /** Default minimum number of samples to pass judgement */
    const DEFAULT_MINIMUM_SAMPLES = RansomwareConfiguration::DEFAULT_MINIMUM_SAMPLES;

    /** Default maximum number of samples to pass judgement */
    const DEFAULT_MAXIMUM_OCCURRENCES = 3;

    /**
     * @param PDO $pdo
     * @param string $name
     * @param string $description
     * @param float $threshold
     * @param int $minimumSamples
     * @param int $maximumOccurrences
     */
    public function __construct(
        PDO $pdo,
        string $name = self::class,
        string $description = self::DESCRIPTION,
        float $threshold = self::DEFAULT_OCCURRENCE_THRESHOLD,
        int $minimumSamples = self::DEFAULT_MINIMUM_SAMPLES,
        int $maximumOccurrences = self::DEFAULT_MAXIMUM_OCCURRENCES
    ) {
        parent::__construct($pdo, $name, $description, $threshold, $minimumSamples, $maximumOccurrences);
    }

    /**
     * @return int
     */
    protected function getTotalOccurrences(): int
    {
        $knownExtensions = RansomwareConfiguration::getKnownExtensionString();

        $sql = "SELECT COUNT(*)
                FROM entries
                WHERE lower(detected_extension) IN ($knownExtensions)";

        $statement = $this->pdo->prepare($sql);
        $statement->execute();

        $result = $statement->fetchColumn();
        return (int)$result;
    }

    /**
     * @return int
     */
    protected function getDetectedOccurrences(): int
    {
        $knownExtensions = RansomwareConfiguration::getKnownExtensionString();
        $ransomwareExtensions = RansomwareConfiguration::getKnownRansomwareExtensionsString();

        $sql = "SELECT COUNT(*)
                FROM entries
                WHERE lower(detected_extension) IN ($knownExtensions) AND
                    lower(extension) IN ($ransomwareExtensions)";

        $statement = $this->pdo->prepare($sql);
        $statement->execute();

        $result = $statement->fetchColumn();
        return (int) $result;
    }

    /**
     * @return array
     */
    protected function getDetectedOccurrencesFileList(): array
    {
        $knownExtensions = RansomwareConfiguration::getKnownExtensionString();
        $ransomwareExtensions = RansomwareConfiguration::getKnownRansomwareExtensionsString();

        $sql = "SELECT path, filename
                FROM entries
                WHERE lower(detected_extension) IN ($knownExtensions) AND
                    lower(extension) IN ($ransomwareExtensions)
                LIMIT 100";

        $statement = $this->pdo->prepare($sql);
        $statement->execute();

        $result = [];
        while ($row = $statement->fetch(PDO::FETCH_ASSOC, PDO::FETCH_ORI_NEXT)) {
            array_push($result, $row['path'] . $row['filename']);
        }

        return $result;
    }
}
